name: ci

on: [push, pull_request]

jobs:
  build:
    name: ${{ matrix.name }} (${{ matrix.compiler }})

    strategy:
      fail-fast: false
      matrix:
        name:
          - Linux
          - Windows
          - macOS
        compiler: [gcc, clang]

        exclude:
          - name: Windows
            compiler: gcc

        include:
          - name: Linux
            os: ubuntu-20.04  # -latest is still stuck at 18.04
            packages: >-
              libsdl1.2-dev libsdl-mixer1.2-dev
              libsdl-image1.2-dev libsdl-gfx1.2-dev
              libyaml-cpp-dev
            compiler: gcc
            cpp-compiler: g++
            cflags: "-Wall -Wextra"
            cxxflags: "-Wall -Wextra"

          - name: Linux
            os: ubuntu-20.04  # -latest is still stuck at 18.04
            packages: >-
              libsdl1.2-dev libsdl-mixer1.2-dev
              libsdl-image1.2-dev libsdl-gfx1.2-dev
              libyaml-cpp-dev
            compiler: clang
            cpp-compiler: clang++
            cflags: "-Wall -Wextra"
            cxxflags: "-Wall -Wextra"

          - name: Windows
            os: windows-latest
            compiler: clang
            cpp-compiler: clang++
            cmake-args: -A Win32

          - name: macOS
            os: macOS-latest
            packages: yaml-cpp sdl sdl_gfx sdl_image sdl_mixer
            compiler: gcc
            cpp-compiler: g++
            cflags: "-Wall -Wextra"
            cxxflags: "-Wall -Wextra"

          - name: macOS
            os: macOS-latest
            packages: yaml-cpp sdl sdl_gfx sdl_image sdl_mixer
            compiler: clang
            cpp-compiler: clang++
            cflags: "-Wall -Wextra"
            cxxflags: "-Wall -Wextra"

    runs-on: ${{ matrix.os }}

    steps:
      - name: Install packages (Ubuntu)
        if: runner.os == 'Linux'
        run: |
          sudo apt-get update
          sudo apt-get -yq --no-install-suggests --no-install-recommends install ccache ${{ matrix.packages }}

      - name: Install packages (Windows)
        if: runner.os == 'Windows' && matrix.packages
        run: |
          choco install ${{ matrix.packages }}

      - name: Install packages (macOS)
        if: runner.os == 'macOS'
        run: |
          brew update || true  # brew update often fails, no biggie.
          brew install ccache ${{ matrix.packages }}

      - name: Setup Cache
        if: runner.os == 'Linux' || runner.os == 'macOS'
        uses: actions/cache@v2
        with:
          path: ~/.ccache
          key: ccache-${{ runner.os }}-${{ matrix.compiler }}

      - name: Checkout
        uses: actions/checkout@v2

      - name: Download dependencies (Windows)
        if: runner.os == 'Windows'
        run: |
          Invoke-WebRequest -Uri "https://openxcom.org/download/dev/openxcom-deps-win-vc2017.zip" -OutFile "openxcom-deps-win-vc2017-newest.zip"
          Expand-Archive -Path "openxcom-deps-win-vc2017-newest.zip"
          Move-Item -Path "openxcom-deps-win-vc2017-newest\deps\*" -Destination "deps"

      - name: Generate project files
        run: |
          mkdir ${{ matrix.build-dir || '.not-used' }}
          cd ${{ matrix.build-dir || '.' }}
          cmake ${{ matrix.build-src-dir || '.' }} -DCMAKE_BUILD_TYPE="Release" -DCHECK_CCACHE=TRUE ${{ matrix.cmake-args }}
        env:
          CC: ${{ matrix.compiler }}
          CXX: ${{ matrix.cpp-compiler }}
          CFLAGS: ${{ matrix.cflags || env.CFLAGS }}
          CXXFLAGS: ${{ matrix.cxxflags || env.CXXFLAGS }}
          LDFLAGS: ${{ matrix.ldflags || env.LDFLAGS }}

      - name: Compile source code
        run: |
          cd ${{ matrix.build-src-dir || '.' }}
          cmake --build . -v -j2 --config ${{ matrix.build-config || 'Release' }}

      - name: Archive artifacts
        #if: runner.os == 'Windows'  # could use if failure()
        uses: actions/upload-artifact@v2
        with:
            name: artifacts ${{ matrix.name }} (${{ matrix.compiler }})
            path: ${{ github.workspace }}

      - name: ccache stats
        if: runner.os == 'Linux' || runner.os == 'macOS'
        run: ccache -s --max-size=390MB
